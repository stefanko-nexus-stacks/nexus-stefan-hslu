name: Cleanup Orphaned Resources

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  cleanup:
    name: Cleanup Orphaned Cloudflare Resources
    runs-on: ubuntu-latest
    env:
      TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      TF_VAR_domain: ${{ secrets.DOMAIN }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cleanup D1 Database
        run: |
          echo "üîç Finding D1 Database..."
          # Resource prefix is derived from domain (e.g., stefanko.ch -> nexus-stefanko-ch)
          DOMAIN="${{ secrets.DOMAIN }}"
          RESOURCE_PREFIX="nexus-${DOMAIN//./-}"
          D1_DATABASE_NAME="${RESOURCE_PREFIX}-db"
          
          # Get all D1 databases
          D1_DATABASES_RESPONSE=$(curl -s \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/d1/database" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          D1_DATABASE_ID=$(echo "$D1_DATABASES_RESPONSE" | jq -r ".result[] | select(.name == \"$D1_DATABASE_NAME\") | .uuid" 2>/dev/null || echo "")
          
          if [ -n "$D1_DATABASE_ID" ] && [ "$D1_DATABASE_ID" != "null" ]; then
            echo "  Found D1 Database ID: $D1_DATABASE_ID"
            
            # Delete the database
            D1_DELETE_RESPONSE=$(curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/d1/database/$D1_DATABASE_ID" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")
            
            if echo "$D1_DELETE_RESPONSE" | grep -q '"success":true'; then
              echo "‚úÖ D1 Database deleted"
            else
              echo "‚ö†Ô∏è  Could not delete D1 Database"
              echo "$D1_DELETE_RESPONSE" | jq '.' 2>/dev/null || echo "$D1_DELETE_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è  D1 Database not found (may already be deleted)"
          fi

      - name: Cleanup Access Application
        run: |
          echo "üîç Finding Access Application..."
          ACCESS_APP_DOMAIN="control.${{ secrets.DOMAIN }}"
          
          # Get all Access applications for the zone
          ACCESS_APPS_RESPONSE=$(curl -s \
            "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/access/apps" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          ACCESS_APP_ID=$(echo "$ACCESS_APPS_RESPONSE" | jq -r ".result[] | select(.domain == \"$ACCESS_APP_DOMAIN\") | .id" 2>/dev/null || echo "")
          
          if [ -n "$ACCESS_APP_ID" ] && [ "$ACCESS_APP_ID" != "null" ]; then
            echo "  Found Access Application ID: $ACCESS_APP_ID"
            
            # Delete the Access Application
            ACCESS_DELETE_RESPONSE=$(curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/access/apps/$ACCESS_APP_ID" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")
            
            if echo "$ACCESS_DELETE_RESPONSE" | grep -q '"success":true'; then
              echo "‚úÖ Access Application deleted"
            else
              echo "‚ö†Ô∏è  Could not delete Access Application"
              echo "$ACCESS_DELETE_RESPONSE" | jq '.' 2>/dev/null || echo "$ACCESS_DELETE_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è  Access Application not found (may already be deleted)"
          fi

      - name: Summary
        run: |
          echo ""
          echo "‚úÖ Cleanup complete!"
          echo ""
          echo "You can now deploy via GitHub Actions again."
