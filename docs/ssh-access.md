# SSH Access Guide

This guide explains how to connect to the Nexus-Stack server via SSH for debugging and maintenance.

> **Note:** All SSH traffic goes through Cloudflare Tunnel - there are no open ports on the server.

---

## Prerequisites

1. **cloudflared** installed:
   ```bash
   # macOS
   brew install cloudflared

   # Linux
   curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
   chmod +x cloudflared && sudo mv cloudflared /usr/local/bin/
   ```

2. **Access to Infisical** at `https://infisical.yourdomain.com` (or GitHub Secrets)

---

## 1. Get SSH Key from Infisical

The SSH key is generated by the GitHub Actions pipeline and stored in Infisical (base64 encoded).

1. Login to Infisical at `https://infisical.yourdomain.com`
2. Navigate to **Secrets** → **dev** environment
3. Find the secret `SSH_PRIVATE_KEY_BASE64`
4. Copy the value

### Decode and Save the Key

```bash
# Create .ssh directory if needed
mkdir -p ~/.ssh && chmod 700 ~/.ssh

# Decode and save (paste the base64 value)
echo "PASTE_BASE64_VALUE_HERE" | base64 -d > ~/.ssh/nexus_key

# Set correct permissions (required!)
chmod 600 ~/.ssh/nexus_key
```

**Alternative: Get from GitHub Secrets**

If you have GitHub CLI access:
```bash
# View the secret (requires appropriate permissions)
gh secret list
# Note: GitHub doesn't allow reading secret values directly
# Use Infisical instead, or re-run setup-control-plane to regenerate
```

---

## 2. Configure SSH

Add this configuration to `~/.ssh/config`:

```
# Nexus-Stack Server
Host nexus
  HostName ssh.yourdomain.com
  User root
  IdentityFile ~/.ssh/nexus_key
  IdentitiesOnly yes
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null
  ProxyCommand cloudflared access ssh --hostname %h
```

> **Security Note:** `StrictHostKeyChecking no` disables host key verification. This is acceptable here because:
> 1. The connection goes through Cloudflare Tunnel (authenticated)
> 2. The server is recreated frequently, changing the host key each time

---

## 3. Connect

```bash
ssh nexus
```

On first connection, Cloudflare Access will open a browser window for authentication (email OTP). After authenticating, the SSH session will connect.

---

## 4. Handling Host Key Changes

The server host key changes every time the infrastructure is recreated (teardown/spin-up). If you see this error:

```
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
```

### Solution A: Use the Config Above (Recommended)

The SSH config with `StrictHostKeyChecking no` and `UserKnownHostsFile /dev/null` prevents this issue entirely.

### Solution B: Clear Old Host Key Manually

```bash
ssh-keygen -R ssh.yourdomain.com
```

Then reconnect.

---

## 5. Common Commands

Once connected, useful commands:

```bash
# View running containers
docker ps

# View all containers (including stopped)
docker ps -a

# View logs for a specific service
docker logs hoppscotch
docker logs hoppscotch-db

# Follow logs in real-time
docker logs -f hoppscotch

# Restart a service
docker restart hoppscotch

# View container health
docker inspect hoppscotch --format='{{.State.Health.Status}}'

# Check disk space
df -h

# View system resources
htop
```

---

## 6. Troubleshooting

### "Permission denied (publickey)"

**Cause:** SSH key doesn't match the one on the server.

**Solution:**
1. Get fresh key from Infisical (see Step 1)
2. Ensure correct permissions: `chmod 600 ~/.ssh/nexus_key`

### "Host key verification failed"

**Cause:** Server was recreated, host key changed.

**Solution:**
```bash
ssh-keygen -R ssh.yourdomain.com
```

Or use the recommended SSH config with `StrictHostKeyChecking no`.

### Browser Opens but SSH Fails

**Cause:** Cloudflare Access authentication required.

**Solution:**
1. Complete the email OTP authentication in browser
2. Retry SSH connection immediately after

### "cloudflared: command not found"

**Cause:** cloudflared not installed.

**Solution:**
```bash
brew install cloudflared  # macOS
```

---

## 7. Service Token (CI/CD Access)

For headless/automated SSH access (e.g., in CI/CD), use Service Tokens instead of browser authentication.

### SSH Config with Service Token

```
Host nexus
  HostName ssh.yourdomain.com
  User root
  IdentityFile ~/.ssh/nexus_key
  IdentitiesOnly yes
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null
  ProxyCommand bash -c 'TUNNEL_SERVICE_TOKEN_ID=YOUR_TOKEN_ID.access TUNNEL_SERVICE_TOKEN_SECRET=YOUR_TOKEN_SECRET cloudflared access ssh --hostname %h'
```

Service Token credentials are stored in GitHub Secrets and can be found in the Cloudflare Zero Trust dashboard under **Access** → **Service Auth** → **Service Tokens**.

---

## Summary

| Step | Command |
|------|---------|
| Install cloudflared | `brew install cloudflared` |
| Get key from Infisical | Decode `SSH_PRIVATE_KEY_BASE64` |
| Save key | `chmod 600 ~/.ssh/nexus_key` |
| Configure SSH | Edit `~/.ssh/config` |
| Connect | `ssh nexus` |
| Clear host key (if needed) | `ssh-keygen -R ssh.yourdomain.com` |
