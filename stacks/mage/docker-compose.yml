# =============================================================================
# Mage AI - Data Pipeline Platform
# =============================================================================
# Modern replacement for Airflow - build, run, and manage data pipelines
# Accessible via: https://mage.<domain>
#
# Port: 6789 (mapped via Cloudflare Tunnel)
#
# Default credentials:
#   Email: ${USER_EMAIL} (or ${ADMIN_EMAIL} if no user)
#   Password: Generated by OpenTofu (stored in Infisical)
#
# Documentation: https://docs.mage.ai
# =============================================================================

services:
  mage:
    image: mageai/mageai:latest
    container_name: mage
    restart: unless-stopped
    ports:
      - "6789:6789"
    environment:
      # Project configuration
      USER_CODE_PATH: /home/src/default_repo
      MAGE_DATA_DIR: /home/src/mage_data
      # Authentication - use Nexus-Stack user credentials (fallback to admin applied in deployment)
      REQUIRE_USER_AUTHENTICATION: "true"
      DEFAULT_OWNER_EMAIL: ${USER_EMAIL}
      DEFAULT_OWNER_PASSWORD: ${MAGE_ADMIN_PASSWORD}
      DEFAULT_OWNER_USERNAME: ${ADMIN_USERNAME:-admin}
      # Server settings
      MAGE_PUBLIC_HOST: https://mage.${DOMAIN}
    volumes:
      - mage_data:/home/src
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6789/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  mage_data:

networks:
  app-network:
    external: true
