# =============================================================================
# Garage - Lightweight S3-Compatible Object Storage
# =============================================================================
# Self-hosted S3-compatible storage designed for simplicity
# Accessible via: https://garage.<domain>
#
# Port: 3909 (Web UI), 3900 (S3 API), 3903 (Admin API)
#
# Default credentials:
#   Admin Token: Generated by OpenTofu (stored in Infisical)
#   S3 keys: Created during post-start setup
#
# Documentation: https://garagehq.deuxfleurs.fr/documentation/
# =============================================================================

services:
  garage:
    image: ${IMAGE_GARAGE:-dxflrs/garage:v2.2.0}
    container_name: garage
    restart: unless-stopped
    ports:
      - "3900:3900"  # S3 API
      - "3901:3901"  # RPC
      - "3903:3903"  # Admin API
    volumes:
      - garage_meta:/var/lib/garage/meta
      - garage_data:/var/lib/garage/data
      - ./garage.toml:/etc/garage.toml:ro
    networks:
      - app-network
      - garage-internal
    healthcheck:
      test: ["CMD", "/garage", "stats"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  garage-webui:
    image: ${IMAGE_WEBUI:-khairul169/garage-webui:latest}
    container_name: garage-webui
    restart: unless-stopped
    ports:
      - "3909:3909"
    env_file: .env
    environment:
      # Garage WebUI uses API_ADMIN_KEY, API_BASE_URL, S3_ENDPOINT_URL
      # GARAGE_ADMIN_TOKEN is loaded from .env
      API_ADMIN_KEY: ${GARAGE_ADMIN_TOKEN}
      API_BASE_URL: http://garage:3903
      S3_ENDPOINT_URL: http://garage:3900
      S3_REGION: garage
      PORT: "3909"
    depends_on:
      garage:
        condition: service_healthy
    networks:
      - app-network
      - garage-internal

volumes:
  garage_meta:
  garage_data:

networks:
  app-network:
    external: true
  garage-internal:
    driver: bridge
