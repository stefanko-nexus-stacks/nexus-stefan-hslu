# =============================================================================
# Gitea - Self-hosted Git Service
# =============================================================================
# Open-source Git hosting with pull requests, code review, and CI/CD.
# Accessible via: https://gitea.<domain>
#
# Port: 3200 (Web UI + API)
#
# Default credentials:
#   Admin user created automatically via CLI
#   Credentials: Generated by OpenTofu (stored in Infisical)
#
# Repository data and database are stored on persistent Hetzner Cloud Volume
# at /mnt/nexus-data/gitea/ (survives teardown)
#
# Documentation: https://docs.gitea.com
# =============================================================================

services:
  gitea:
    image: ${IMAGE_GITEA:-gitea/gitea:1.23}
    container_name: gitea
    restart: unless-stopped
    ports:
      - "3200:3000"
    env_file: .env
    environment:
      USER_UID: "1000"
      USER_GID: "1000"
      GITEA__database__DB_TYPE: postgres
      GITEA__database__HOST: gitea-db:5432
      GITEA__database__NAME: gitea
      GITEA__database__USER: nexus-gitea
      GITEA__database__PASSWD: ${GITEA_DB_PASSWORD}
      GITEA__server__ROOT_URL: https://gitea.${DOMAIN}
      GITEA__server__SSH_DOMAIN: gitea.${DOMAIN}
      GITEA__server__DOMAIN: gitea.${DOMAIN}
      GITEA__service__DISABLE_REGISTRATION: "true"
      GITEA__security__INSTALL_LOCK: "true"
    volumes:
      - /mnt/nexus-data/gitea/repos:/data/git/repositories
      - /mnt/nexus-data/gitea/lfs:/data/git/lfs
      - gitea_data:/data
    depends_on:
      gitea-db:
        condition: service_healthy
    networks:
      - app-network
      - gitea-internal
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  gitea-db:
    image: ${IMAGE_POSTGRES:-postgres:16-alpine}
    container_name: gitea-db
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_USER: nexus-gitea
      POSTGRES_DB: gitea
      POSTGRES_PASSWORD: ${GITEA_DB_PASSWORD}
    volumes:
      - /mnt/nexus-data/gitea/db:/var/lib/postgresql/data
    networks:
      - gitea-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nexus-gitea -d gitea"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  gitea_data:

networks:
  app-network:
    external: true
  gitea-internal:
    driver: bridge
