# =============================================================================
# Dify - AI Workflow Builder & LLM Application Platform
# =============================================================================
# Production-ready platform for building AI-powered applications, workflows,
# and agents with visual orchestration and RAG capabilities.
#
# Features:
#   - Visual workflow builder for AI applications
#   - RAG pipeline with vector database integration
#   - Multi-model support (OpenAI, Anthropic, local models)
#   - Code execution sandbox for dynamic workflows
#   - Plugin ecosystem for extending functionality
#
# Access: https://dify.YOUR_DOMAIN
# Credentials: See Infisical (DIFY_USERNAME / DIFY_PASSWORD)
#
# Data is stored on persistent Hetzner Cloud Volume
# at /mnt/nexus-data/dify/ (survives teardown)
# =============================================================================

x-dify-shared: &dify-shared
  restart: unless-stopped
  env_file:
    - .env
  environment: &dify-env
    # Database
    DB_USERNAME: nexus-dify
    DB_PASSWORD: ${DIFY_DB_PASSWORD}
    DB_HOST: dify-db
    DB_PORT: "5432"
    DB_DATABASE: dify
    # Redis
    REDIS_HOST: dify-redis
    REDIS_PORT: "6379"
    REDIS_PASSWORD: ${DIFY_REDIS_PASSWORD}
    REDIS_DB: "0"
    CELERY_BROKER_URL: redis://:${DIFY_REDIS_PASSWORD}@dify-redis:6379/1
    # Security
    SECRET_KEY: ${DIFY_SECRET_KEY}
    INIT_PASSWORD: ${DIFY_ADMIN_PASSWORD}
    # Database migrations
    MIGRATION_ENABLED: "true"
    # URLs (empty = auto-detect from request)
    CONSOLE_API_URL: ""
    CONSOLE_WEB_URL: ""
    SERVICE_API_URL: ""
    APP_API_URL: ""
    APP_WEB_URL: ""
    FILES_URL: ""
    # Vector store
    VECTOR_STORE: weaviate
    WEAVIATE_ENDPOINT: http://dify-weaviate:8080
    WEAVIATE_API_KEY: ${DIFY_WEAVIATE_API_KEY}
    # Sandbox
    CODE_EXECUTION_ENDPOINT: http://dify-sandbox:8194
    CODE_EXECUTION_API_KEY: ${DIFY_SANDBOX_API_KEY}
    # SSRF proxy
    SSRF_PROXY_HTTP_URL: http://dify-ssrf-proxy:3128
    SSRF_PROXY_HTTPS_URL: http://dify-ssrf-proxy:3128
    # Plugin daemon
    PLUGIN_DAEMON_URL: http://dify-plugin-daemon:5002
    PLUGIN_DAEMON_KEY: ${DIFY_PLUGIN_DAEMON_KEY}
    PLUGIN_DIFY_INNER_API_KEY: ${DIFY_PLUGIN_INNER_API_KEY}
    # Storage
    STORAGE_TYPE: local
    STORAGE_LOCAL_PATH: /app/api/storage

services:
  # ---------------------------------------------------------------------------
  # Dify API - Backend Server
  # ---------------------------------------------------------------------------
  dify-api:
    <<: *dify-shared
    image: ${IMAGE_DIFY:-langgenius/dify-api:1.13.0}
    container_name: dify-api
    environment:
      <<: *dify-env
      MODE: api
    volumes:
      - /mnt/nexus-data/dify/storage:/app/api/storage
    depends_on:
      dify-db:
        condition: service_healthy
      dify-redis:
        condition: service_healthy
    networks:
      - dify-internal
      - dify-ssrf

  # ---------------------------------------------------------------------------
  # Dify Worker - Celery Async Worker
  # ---------------------------------------------------------------------------
  dify-worker:
    <<: *dify-shared
    image: ${IMAGE_DIFY:-langgenius/dify-api:1.13.0}
    container_name: dify-worker
    environment:
      <<: *dify-env
      MODE: worker
    volumes:
      - /mnt/nexus-data/dify/storage:/app/api/storage
    depends_on:
      dify-db:
        condition: service_healthy
      dify-redis:
        condition: service_healthy
    networks:
      - dify-internal
      - dify-ssrf

  # ---------------------------------------------------------------------------
  # Dify Worker Beat - Celery Beat Scheduler
  # ---------------------------------------------------------------------------
  dify-worker-beat:
    <<: *dify-shared
    image: ${IMAGE_DIFY:-langgenius/dify-api:1.13.0}
    container_name: dify-worker-beat
    environment:
      <<: *dify-env
      MODE: worker
      CELERY_AUTO_SETUP: "false"
    depends_on:
      dify-db:
        condition: service_healthy
      dify-redis:
        condition: service_healthy
    networks:
      - dify-internal

  # ---------------------------------------------------------------------------
  # Dify Web - Next.js Frontend
  # ---------------------------------------------------------------------------
  dify-web:
    image: ${IMAGE_DIFY_WEB:-langgenius/dify-web:1.13.0}
    container_name: dify-web
    restart: unless-stopped
    environment:
      CONSOLE_API_URL: ""
      APP_API_URL: ""
    networks:
      - dify-internal

  # ---------------------------------------------------------------------------
  # Nginx - Reverse Proxy (combines web + api)
  # ---------------------------------------------------------------------------
  dify-nginx:
    image: ${IMAGE_DIFY_NGINX:-nginx:alpine}
    container_name: dify
    restart: unless-stopped
    ports:
      - "8501:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/proxy.conf:/etc/nginx/proxy.conf:ro
    depends_on:
      - dify-api
      - dify-web
      - dify-plugin-daemon
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:80/ || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
    networks:
      - app-network
      - dify-internal

  # ---------------------------------------------------------------------------
  # PostgreSQL - Dedicated Database
  # ---------------------------------------------------------------------------
  dify-db:
    image: ${IMAGE_DIFY_POSTGRES:-postgres:15-alpine}
    container_name: dify-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: nexus-dify
      POSTGRES_PASSWORD: ${DIFY_DB_PASSWORD}
      POSTGRES_DB: dify
    volumes:
      - /mnt/nexus-data/dify/db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nexus-dify -d dify"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dify-internal

  # ---------------------------------------------------------------------------
  # Redis - Cache & Message Broker
  # ---------------------------------------------------------------------------
  dify-redis:
    image: ${IMAGE_DIFY_REDIS:-redis:6-alpine}
    container_name: dify-redis
    restart: unless-stopped
    command: redis-server --requirepass ${DIFY_REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - /mnt/nexus-data/dify/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${DIFY_REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dify-internal

  # ---------------------------------------------------------------------------
  # Weaviate - Vector Database for RAG
  # ---------------------------------------------------------------------------
  dify-weaviate:
    image: ${IMAGE_DIFY_WEAVIATE:-semitechnologies/weaviate:1.27.0}
    container_name: dify-weaviate
    restart: unless-stopped
    environment:
      QUERY_DEFAULTS_LIMIT: "25"
      AUTHENTICATION_APIKEY_ENABLED: "true"
      AUTHENTICATION_APIKEY_ALLOWED_KEYS: ${DIFY_WEAVIATE_API_KEY}
      AUTHENTICATION_APIKEY_USERS: "nexus-dify"
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "false"
      DEFAULT_VECTORIZER_MODULE: "none"
      CLUSTER_HOSTNAME: dify-weaviate
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
    volumes:
      - /mnt/nexus-data/dify/weaviate:/var/lib/weaviate
    networks:
      - dify-internal

  # ---------------------------------------------------------------------------
  # Sandbox - Code Execution Environment
  # ---------------------------------------------------------------------------
  dify-sandbox:
    image: ${IMAGE_DIFY_SANDBOX:-langgenius/dify-sandbox:0.2.12}
    container_name: dify-sandbox
    restart: unless-stopped
    environment:
      API_KEY: ${DIFY_SANDBOX_API_KEY}
      GIN_MODE: release
      WORKER_TIMEOUT: "15"
      ENABLE_NETWORK: "true"
      SANDBOX_PORT: "8194"
      HTTP_PROXY: http://dify-ssrf-proxy:3128
      HTTPS_PROXY: http://dify-ssrf-proxy:3128
    networks:
      - dify-ssrf

  # ---------------------------------------------------------------------------
  # SSRF Proxy - Security Proxy
  # ---------------------------------------------------------------------------
  dify-ssrf-proxy:
    image: ${IMAGE_DIFY_SSRF_PROXY:-ubuntu/squid:latest}
    container_name: dify-ssrf-proxy
    restart: unless-stopped
    volumes:
      - ./ssrf_proxy/squid.conf:/etc/squid/squid.conf:ro
    networks:
      - dify-ssrf
      - dify-internal

  # ---------------------------------------------------------------------------
  # Plugin Daemon - Plugin Lifecycle Management
  # ---------------------------------------------------------------------------
  dify-plugin-daemon:
    image: ${IMAGE_DIFY_PLUGIN_DAEMON:-langgenius/dify-plugin-daemon:0.5.3-local}
    container_name: dify-plugin-daemon
    restart: unless-stopped
    environment:
      # Database
      DB_TYPE: postgresql
      DB_HOST: dify-db
      DB_PORT: "5432"
      DB_USERNAME: nexus-dify
      DB_PASSWORD: ${DIFY_DB_PASSWORD}
      DB_DATABASE: dify
      # Redis (required for plugin manager)
      REDIS_HOST: dify-redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${DIFY_REDIS_PASSWORD}
      # Server
      SERVER_PORT: "5002"
      SERVER_KEY: ${DIFY_PLUGIN_DAEMON_KEY}
      DIFY_INNER_API_KEY: ${DIFY_PLUGIN_INNER_API_KEY}
      DIFY_INNER_API_URL: http://dify-api:5001
      # Plugin config
      PLUGIN_REMOTE_INSTALLING_HOST: "0.0.0.0"
      PLUGIN_REMOTE_INSTALLING_PORT: "5003"
      PLUGIN_WORKING_PATH: /app/storage/cwd
      PLUGIN_STORAGE_TYPE: local
      PLUGIN_STORAGE_LOCAL_ROOT: /app/storage
      FORCE_VERIFYING_SIGNATURE: "true"
      MAX_PLUGIN_PACKAGE_SIZE: "52428800"
      PPROF_ENABLED: "false"
    volumes:
      - /mnt/nexus-data/dify/plugins:/app/storage
    depends_on:
      dify-db:
        condition: service_healthy
      dify-redis:
        condition: service_healthy
    networks:
      - dify-internal

# =============================================================================
# Networks
# =============================================================================
networks:
  app-network:
    external: true
  dify-internal:
    driver: bridge
  dify-ssrf:
    driver: bridge
    internal: true
