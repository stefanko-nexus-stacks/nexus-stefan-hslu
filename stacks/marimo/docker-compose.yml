# =============================================================================
# Marimo - Reactive Python Notebook
# https://marimo.${DOMAIN}
# =============================================================================
# Marimo is a reactive Python notebook that's reproducible, git-friendly,
# and deployable as apps. SQL variant includes DuckDB and data analysis tools.
#
# Git Integration: If Gitea is enabled, the shared workspace repo is
# auto-cloned into /app/notebooks/.
# =============================================================================

services:
  marimo:
    image: ${IMAGE_MARIMO:-ghcr.io/marimo-team/marimo:latest-sql}
    container_name: marimo
    restart: unless-stopped
    entrypoint: >
      sh -c "
        if [ -n \"$$GITEA_USERNAME\" ] && [ -n \"$$GITEA_PASSWORD\" ]; then
          echo \"machine gitea login $$GITEA_USERNAME password $$GITEA_PASSWORD\" > ~/.netrc;
          chmod 600 ~/.netrc;
        fi;
        if [ -n \"$$GITEA_REPO_URL\" ] && [ ! -d /app/notebooks/$$REPO_NAME/.git ]; then
          if ! command -v git >/dev/null 2>&1; then
            apk add --no-cache git || echo '[marimo] Warning: Failed to install git' >&2;
          fi;
          if command -v git >/dev/null 2>&1; then
            if git clone \"$$GITEA_REPO_URL\" /app/notebooks/$$REPO_NAME; then
              echo '[marimo] Cloned Git repo into /app/notebooks/'$$REPO_NAME;
            else
              echo '[marimo] Warning: Failed to clone '$$GITEA_REPO_URL >&2;
            fi;
          fi;
        fi;
        exec marimo edit --host 0.0.0.0 --port 8080 --no-token /app/notebooks
      "
    env_file:
      - path: .env
        required: false
    ports:
      - "2718:8080"
    environment:
      - HOST=0.0.0.0
      - PORT=8080
    volumes:
      - marimo_data:/app/notebooks
    networks:
      - app-network

volumes:
  marimo_data:

networks:
  app-network:
    external: true
